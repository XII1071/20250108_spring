<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/basic::setContent(~{this::content})}">
    <th:block th:fragment="content">
        <style>
            .form-group { margin-bottom: 20px; }
            .uploadResult { width: 100%; background: gray; margin-top: 10px; }
            .uploadResult ul {
                display: flex; flex-flow: row; justify-content: center;
                align-items: center; vertical-align: top; overflow: auto;
            }
            .uploadResult ul li { list-style: none; padding: 10px; margin-left: 2em; }
            .uploadResult ul li img { width: 100px; }
        </style>

        <h1 class="mt-4">Movie Modify Page</h1>

        <form th:action="@{/movie/modify}" th:method="post" id="frmSend">
            <div class="form-group">
                <label for="mno">Mno</label>
                <input type="text" name="mno" id="mno" class="form-control" readonly th:value="${movieDTO.mno}">
            </div>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" name="title" id="title" class="form-control" th:value="${movieDTO.title}">
            </div>
            <div class="form-group">
                <label for="fileInput">Select Image Files</label>
                <input type="file" id="fileInput" class="custom-file-input form-control files" multiple>
                <label id="custom-label"></label>
            </div>
            <div class="box"></div>
            <div class="form-group">
                <button type="button" class="btn btn-primary btnModi">Modify</button>
                <button type="button" class="btn btn-danger btnDele">Delete</button>
                <button type="button" class="btn btn-info btnBack">Back</button>
            </div>
        </form>

        <div class="uploadResult">
            <ul>
                <li th:each="movieImageDTO : ${movieDTO.imageDTOList}"
                    th:data-path="${movieImageDTO.path}"
                    th:data-uuid="${movieImageDTO.uuid}"
                    th:data-file="${movieImageDTO.getImageURL}"
                    th:data-name="${movieImageDTO.imgName}">
                    <div>
                        <button type="button" class="removeBtn">X</button>
                        <img th:src="@{/display(fileName=${movieImageDTO.getThumbnailURL})}" alt="이미지">
                    </div>
                </li>
            </ul>
        </div>

        <!-- 모달 -->
        <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">삭제 확인</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        삭제가 완료되었습니다.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            document.addEventListener("DOMContentLoaded", function () {
                const mno = [[${movieDTO.mno}]];
                const btnModi = document.querySelector(".btnModi");
                const btnDele = document.querySelector(".btnDele");
                const btnBack = document.querySelector(".btnBack");
                const frmSend = document.querySelector("#frmSend");

                // ✅ Modify 버튼
                btnModi.onclick = function (e) {
                    e.preventDefault();
                    if (document.querySelector("#title").value.trim() === "") {
                        alert("제목을 입력하세요.");
                        return;
                    }

                    let hiddenInputs = "";
                    const liArr = document.querySelectorAll(".uploadResult ul li");
                    liArr.forEach((li, index) => {
                        hiddenInputs += `
                            <input type="hidden" name="imageDTOList[${index}].imgName" value="${li.dataset.name}">
                            <input type="hidden" name="imageDTOList[${index}].path" value="${li.dataset.path}">
                            <input type="hidden" name="imageDTOList[${index}].uuid" value="${li.dataset.uuid}">
                        `;
                    });

                    document.querySelector(".box").innerHTML = hiddenInputs;
                    frmSend.submit();
                };

                // ✅ Delete 버튼
                btnDele.onclick = function (e) {
                    e.preventDefault();

                    if (!confirm("정말로 삭제하시겠습니까?")) {
                        return;
                    }

                    fetch(`/movie/delete/${mno}`, { method: 'DELETE' })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("삭제 요청 실패");
                            }
                            return response.text();
                        })
                        .then(() => {
                            const myModal = new bootstrap.Modal(document.querySelector('#myModal'), { backdrop: 'static' });
                            myModal.show();
                            setTimeout(() => {
                                window.location.href = '/movie/list';
                            }, 1000);
                        })
                        .catch(error => {
                            console.error("삭제 중 오류 발생:", error);
                            alert("삭제 중 오류가 발생했습니다.");
                        });
                };

                // ✅ Back 버튼
                btnBack.onclick = function (e) {
                    e.preventDefault();
                    window.history.back();
                };
            });
        </script>
    </th:block>
</th:block>
</html>
